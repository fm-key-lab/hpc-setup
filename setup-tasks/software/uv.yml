version: '3'

vars:
  GROUP_HOME:
    sh: echo $GROUP_HOME
  OPT_DIR: '{{.GROUP_HOME}}/opt'

includes:
  group-installs: ../utils/GroupInstalls.yml
  utils: ../../lab-tasks
  rust: ./Rust.yml

tasks:
  install:
    desc: Install uv
    vars:
      RUST_VERSION: '{{.RUST_VERSION | default "1.82.0"}}'
      VERSION: '{{.VERSION | default "0.4.26"}}'
    cmds:
      - task: run-installer-script
        vars:
          RUST_MODULE: 'rust/{{.RUST_VERSION}}'
          VERSION: '{{.VERSION}}'
      - task: group-installs:complete
        vars:
          APP: uv
          EXE: uv
          RELPATH_EXE: /bin/
          VERSION: '{{.VERSION}}'

  run-installer-script:
    deps:
      - task: rust:install
        vars:
          VERSION: '{{.RUST_VERSION}}'
    vars:
      DIR: '{{.OPT_DIR}}/uv/{{.VERSION}}'
      URL: https://github.com/astral-sh/uv/releases/download/{{.VERSION}}/
    dir: '{{.DIR}}'
    prompt: 'Install uv in {{.DIR}}?'
    cmds:
      - task: utils:envmodule:run-inside
        vars:
          CMDS: export CARGO_HOME={{.DIR}} && curl --proto '=https' --tlsv1.2 -LsSf {{.URL}} && uv-installer.sh | sh -s -- --no-modify-path
          MODULE: '{{.RUST_MODULE}}'
    requires:
      vars: [OPT_DIR, RUST_MODULE, VERSION]
    status:
      - test -f {{.DIR}}/bin/uv
