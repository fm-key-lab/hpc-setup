version: '3'

vars:
  GROUP_HOME:
    sh: echo $GROUP_HOME
  OPT_DIR: '{{.GROUP_HOME}}/opt'

includes:
  group-installs: ../utils/GroupInstalls.yml
  utils: ../../lab-tasks
  python: ./Python.yml
  uv: ./uv.yml

tasks:
  install:
    desc: Install csvkit
    summary: |
      Install csvkit

      URLs
      ----
       - GitHub: https://github.com/wireservice/csvkit
       - Docs: https://csvkit.readthedocs.io/en/latest/index.html
    vars:
      APP: csvkit
      VERSION: '{{.VERSION | default "2.0.1"}}'
      EXE: csvcut csvjoin csvlook csvstack csvstat in2csv # TODO: Unused
      PYTHON_VERSION: '{{.PYTHON_VERSION | default "3.12.4"}}'
      PYTHON_MODULE: python/3.12 # TODO
      UV_VERSION: '{{.VERSION | default "0.2.34"}}'
      UV_MODULE: 'uv/{{.UV_VERSION}}'
    cmds:
      - task: create-virtual-environment
        vars:
          PYTHON_VERSION: '{{.PYTHON_VERSION}}'
          PYTHON_MODULE: '{{.PYTHON_MODULE}}'
          UV_VERSION: '{{.UV_VERSION}}'
          UV_MODULE: '{{.UV_MODULE}}'
          VERSION: '{{.VERSION}}'
      - task: group-installs:write-modulefile-stub
        vars:
          APP: '{{.APP}}'
          VERSION: '{{.VERSION}}'
          RELPATH_EXE: /.venv/bin/

  create-virtual-environment:
    deps:
      - task: python:install
        vars:
          VERSION: '{{.PYTHON_VERSION}}'
      - task: uv:install
        vars:
          VERSION: '{{.UV_VERSION}}'
    vars:
      DIR: '{{.OPT_DIR}}/csvkit/{{.VERSION}}'
    dir: '{{.DIR}}'
    prompt: Create environment in {{.DIR}}?
    cmds:
      # TODO: Replace with the uv create env task
      - task: utils:envmodule:run-inside
        vars:
          CMDS: |
            cd {{.DIR}} && 
            uv venv && 
            uv pip install csvkit=={{.VERSION}}
          MODULE: '{{.UV_MODULE}} {{.PYTHON_MODULE}}'
    requires:
      vars: [PYTHON_MODULE, UV_MODULE, VERSION]
    status:
      - test -d {{.DIR}}/.venv/bin/activate