version: '3'

vars:
  GROUP_HOME:
    sh: echo $GROUP_HOME
  OPT_DIR: "{{.GROUP_HOME}}/opt"

includes:
  group-installs: ../utils/GroupInstalls.yml

tasks:
  install:
    desc: Install Python3
    vars:
      APP: 'python'
      VERSION: '{{.VERSION | default "3.12.4"}}'      
    cmds:
      - task: build
        vars:
          VERSION: '{{.VERSION}}'
      # TODO: Check exact items in assets.
      # - task: group-installs:complete
      #   vars:
      #     APP: '{{.APP}}'
      #     VERSION: '{{.VERSION_CLI}}'
      #     RELPATH_EXE: /bin/
      #     EXE: python3.12 pip3.12

  build:
    vars:
      DIR: '{{.OPT_DIR}}/python/{{.VERSION}}'
      URL: https://www.python.org/ftp/python/{{.VERSION}}/Python-{{.VERSION}}.tgz
      ENABLE_OPTIMIZATIONS:
        sh: '[ "${{{.VERSION}}}" -gt 3 ] && echo "--enable-optimizations" || echo ""'
    dir: '{{.DIR}}'
    cmds:
      - wget {{.URL}}
      - defer: rm -f $(basename ${{.URL}})
      - tar xf $(basename ${{.URL}})
      - |
        cd Python-{{.VERSION}}
        ./configure --prefix={{.DIR}} {{.ENABLE_OPTIMIZATIONS}}
        make
        make altinstall
    status:
      - test -f {{.DIR}}/bin/python*