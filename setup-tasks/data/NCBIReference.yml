version: '3'

vars:
  JQ: $GROUP_HOME/bin/jq
  NCBI_REFERENCE_URL: https://ftp.ncbi.nlm.nih.gov/genomes/
  NCBI_DATASETS_MODULE: ncbi_datasets/16.29.0

  # NOTE: Must be JSON
  DEFAULT_REFS_CFG: '{{.ROOT_DIR}}/config/core-reference-genomes.json'  
  # DEFAULT_REFS_CFG: '{{.TASKFILE_DIR}}/core-reference-genomes.json'
  REFS_CFG: '{{.REFS_CFG | default .DEFAULT_REFS_CFG}}'

  LAB_PUBLIC_DATA_DIR:
    sh: echo "$GROUP_HOME/public_data"  
  REF_GENOMES_DIR: '{{.LAB_PUBLIC_DATA_DIR}}/reference_genomes'

includes:
  utils: ../../lab-tasks
  jq: ../software/jq.yml

tasks:
  download-reference:
    dir: '{{.REF_GENOMES_DIR}}/{{.TAXON}}/{{.ACCESSION}}/{{.SOURCE}}'

  download-core-reference-genomes:
    desc: Download core reference genomes from NCBI
    deps:
      - task: jq:install
    vars:
      REF_KEYS:
        sh: '{{.JQ}} -r "keys[]" {{.REFS_CFG}}'
      REF_ENTRIES:
        sh: '{{.JQ}} -c . {{.REFS_CFG}}'
      REF_ENTRIES_MAP:
        ref: "fromJson .REF_ENTRIES"
    cmds:
      - for: { var: REF_KEYS }
        task: download-ncbi-reference-genome
        vars:
          ACCESSION: '{{index .REF_ENTRIES_MAP .ITEM "accession"}}'
          TAXON: '{{index .REF_ENTRIES_MAP .ITEM "taxon"}}'

  download-ncbi-reference-genome:
    vars:
      PREFIX: '{{.REF_GENOMES_DIR}}/{{.TAXON}}/{{.ACCESSION}}/NCBI'
    dir: '{{.REF_GENOMES_DIR}}/{{.TAXON}}/{{.ACCESSION}}/NCBI'
    cmds:
      - task: utils:envmodule:run-inside
        vars:
          CMDS: datasets download genome accession {{.ACCESSION}} --filename {{.PREFIX}}/ncbi_dataset.zip --include gff3,rna,cds,protein,genome,seq-report
          MODULE: '{{.NCBI_DATASETS_MODULE}}'
      - defer: rm -f {{.PREFIX}}/ncbi_dataset.zip
      - unzip {{.PREFIX}}/ncbi_dataset.zip
    requires:
      vars: [ACCESSION, TAXON]
    status:
      - test -f {{.PREFIX}}/README.md
      - test -d {{.PREFIX}}/ncbi_dataset
      - test -f {{.PREFIX}}/ncbi_dataset/data/assembly_data_report.json
      - test -f {{.PREFIX}}/ncbi_dataset/data/dataset_catalog.json
      - test -d {{.PREFIX}}/ncbi_dataset/data/{{.ACCESSION}}